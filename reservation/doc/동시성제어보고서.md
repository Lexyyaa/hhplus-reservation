#  동시성이슈 및 제어 보고서
콘서트 좌석예약 서비스에서 발생할 수 있는 동시성 이슈에 대해 알아보고 이를 해결하기 한 보고서

### 동시성 이슈 상황

#### 1) 좌석예약
- 기능설명 : 사용자가 선택한 좌석에 대해 선점한다.
- 문제상황 :
    - 여러 사용자가 동일한 좌석에 대해 예약요청을 하는경우에 요청들이 순차적으로 독립되게 처리되지 않는다면 예약정보가 덮어씌여지는 분실 갱신이 발생할 수 있다.
- 목표상황 :
    - 여러 사용자가 하나의 좌석에 대해 예약 요청을 했을때 가장 먼저 요청한 사용자에게 좌석이 할당된다.
    - 다른 사용자들에게는 "이미 예약된 좌석입니다." 라는 메시지가 전달되어야 한다.
  
#### 2) 포인트 충전
- 기능설명 : 사용자가 충전요청한 금액에 대해 정상적으로 충전된다.
- 문제상황 :
    - 사용자가 동시에 여러번의 충전요청을 했을 때 실제 요청한 금액과 충전된 금액이 일치하지 않는 문제가 발생한다.
- 목표상황 :
    - 포인트조회 시 요청한 포인트만큼 순서대로 충전된다.

#### 3) 결제
- 기능설명 : 사용자가 예약한 좌석에 대해 결제한다.
- 문제상황 :
  - 사용자가 동시에 여러번의 결제요청을 했을 때 예약한 정보에 대한 금액만큼 정상적으로 포인트가 차감되지 않을 수 있다.
  - 결제가 되었지만 예약이 확정되지 않거나, 결제가 되지 않았지만 예약이 확정되는 문제가 발생할 수 있다.
- 목표상황 :
    - 사용자가 요청한 예약에 대해 정상적으로 포인트가 차감되고, 해당 좌석이 사용자에게 배정된다.

### 문제 해결과정 

##### 1) 좌석예약
- 동시성 테스트를 위한 코드 및 시나리오
> 1000명의 유저가 동시에 하나의 좌석에 대해 예약요청을 했을 경우 한명만 성공하고 모두 실패한다.


- 낙관적 락 적용 및 실행결과


- 비관적 락 적용 및 실행결과


##### 2) 포인트 충전 
- 동시성 테스트를 위한 코드 및 시나리오
> 한명의 유저가 동시에 500번의 충전요청을 보냈을 때 요청한 만큼의 포인트가 정상적으로 충전된다.


- 낙관적 락 적용 및 실행결과


- 비관적 락 적용 및 실행결과



##### 3) 결제
- 동시성 테스트를 위한 코드 및 시나리오
> 한명의 유저가 예약한 하나의 좌석에 대해 결제요청을 500번을 진행했을 때 해당 좌석이 예약확정되며 이에 맞는 포인트만큼 차감된다.

- 낙관적 락 적용 및 실행결과


- 비관적 락 적용 및 실행결과



참고자료
https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html
https://helloworld.kurly.com/blog/distributed-redisson-lock/#2-redis%EC%9D%98-redisson-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EC%84%A0%EC%A0%95-%EC%9D%B4%EC%9C%A0