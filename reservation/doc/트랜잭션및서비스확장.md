# 서비스 확장에 따른 트랜잭션분리 보고서 생성

## 1. 개요
현재 개발 중인 콘서트 좌석 예약 시스템의 트랜잭션 설계와 서비스 분리 방안에 대한 보고서 입니다.
더 나아가 현재 시스템의 기능들이 모놀리틱 구조에서 마이크로서비스 아키텍처로 확장될 때 발생하는 트랜잭션 처리의 한계와 이에 대한 해결책을 이야기 합니다.

## 2. 기능별 트랜잭션 범위

현재 시스템에서 주요 트랜잭션 단위는 다음과 같습니다.

- **예약가능 콘서트 스케줄 조회**: 예약 가능한 콘서트 스케줄을 확인하는 기능.
```text
    예약가능 콘서트스케줄 조회 TX {
    예약가능_콘서트스케줄_조회()
}
```

- **예약가능 콘서트 스케줄 별 좌석 조회**: 선택한 스케줄의 예약 가능 좌석을 조회하는 기능.
```text
    예약가능 콘서트스케줄 별 좌석조회 TX {
    예약가능_콘서트스케줄_별_좌석조회()
}
```

- **포인트 충전**: 사용자의 포인트 정보를 조회하고 포인트를 충전하는 기능.
```text
    포인트충전 TX {
    유저포인트정보조회()
    포인트충전()
}
```

- **포인트 조회**: 사용자의 포인트 정보를 단순히 조회하는 기능.
```text
   포인트 조회 TX {
    유저포인트정보조회()
}
```

- **좌석 예약**: 특정 좌석의 상태를 변경하고 예약을 확정하는 기능.
```text
    좌석예약 TX {
    좌석상태변경()
    좌석예약()
}
```

- **결제**: 예약 내역 조회, 콘서트 정보 조회, 예약 확정, 결제 내역 생성, 유저 포인트 차감, 토큰 삭제와 같은 작업을 포함한 종합적인 결제 처리.
```text
    결제 TX {
    예약내역조회()
    콘서트정보조회()
    예약확정()
    결제내역생성()
    유저포인트차감()
    토큰삭제()
}
```

## 3. 서비스 분리의 필요성 - 결제

현재는 결제가 여러 도메인의 기능을 포함하고 있습니다. 그러나 서비스가 확장되어 예약, 콘서트, 포인트, 토큰이 각각 독립된 서버에서 운영되면, 트랜잭션 범위가 넓은 `결제` 기능이 문제가 될 수 있습니다. 트랜잭션을 한 번에 완료할 수 없기 때문에 서비스 간의 데이터 일관성 유지와 트랜잭션의 원자성 보장이 어려워집니다.

특히 `토큰삭제`와 같이 결제 내역과 직접적인 관련이 적은 작업은 비동기적으로 분리하여 독립적으로 처리함으로써 서비스의 결합도와 성능을 개선할 수 있습니다.

## 4. 서비스 분리 후 예상되는 트랜잭션 처리의 한계

서비스 분리 후 다음과 같은 문제들이 예상됩니다.

### 4.1 트랜잭션 일관성 문제
모놀리틱 환경에서는 데이터베이스가 트랜잭션의 원자성, 일관성, 격리성, 지속성을 보장하지만, 마이크로서비스 아키텍처에서는 각 서비스가 개별 트랜잭션을 갖기 때문에 복합적인 트랜잭션에서 데이터 일관성 보장이 어렵습니다. 예를 들어 결제 과정에서 예약 서비스와 포인트 서비스가 동시에 참여할 경우, 하나의 트랜잭션에서 오류가 발생하면 각 서비스의 데이터를 일관되게 유지하는 것이 복잡해집니다.

### 4.2 오류 처리 및 롤백 문제
트랜잭션 중 하나의 서비스에서 오류가 발생할 경우 이미 수행된 작업을 롤백하기 어려워집니다. 예를 들어, 포인트 차감 후 예약 확정 과정에서 오류가 발생하면 이미 차감된 포인트를 복구하는 추가 작업이 필요합니다. 이는 각 서비스가 독립적이기 때문에 기존 트랜잭션처럼 자동으로 원자성을 유지하기 어렵습니다.

## 5. 트랜잭션 일관성 문제의 해결 방안: SAGA 패턴 적용

SAGA 패턴은 마이크로서비스 환경에서 데이터 일관성을 보장하기 위한 대표적인 설계 패턴입니다. 전체 비즈니스 트랜잭션을 각 서비스의 개별 로컬 트랜잭션으로 분리하고, 각 트랜잭션이 완료될 때마다 다음 트랜잭션을 진행합니다.

### 5.1 코레오그래피 기반 SAGA
각 서비스가 트랜잭션이 완료되면 완료 이벤트를 발행하고, 다음 서비스를 호출하여 진행하는 방식입니다. 실패 시 보상 트랜잭션 이벤트를 발행하여 롤백을 시도합니다.

- **장점**: 서비스 간 결합도가 낮고, 하나의 서비스에 오류가 발생해도 나머지 시스템에 영향을 적게 미침.
- **단점**: 트랜잭션 흐름이 복잡해지고, 서비스 간 종속성이 생길 수 있음.

### 5.2 오케스트레이션 기반 SAGA
중앙에서 SAGA Orchestrator가 각 서비스의 트랜잭션을 순차적으로 관리하며, 실패 시 보상 트랜잭션을 발생시켜 롤백을 시도합니다.

- **장점**: 트랜잭션 흐름이 명확하고, 서비스 간 결합도를 낮출 수 있음.
- **단점**: 구현의 복잡도가 올라가며, 오케스트레이터 자체의 오류가 발생할 경우 서비스에 심각한 문제를 초래할 수 있음.

### 6. 변경된 결제 프로세스 

#### 6.1. 예약 내역 조회
- `결제 서비스`에서 결제 요청을 받으면, 먼저 `예약 서비스`에서 예약 내역을 조회합니다.
- 예약 내역 조회에 성공하면 **예약조회완료** 이벤트를 발행하여 다음 단계로 진행합니다.
- 조회 실패 시 결제 프로세스를 중단합니다.

```text
예약내역조회 TX {
    예약내역조회()
    이벤트.예약조회완료발행() // 예약 내역 조회 성공 시
}
```
#### 6.2. 콘서트 정보 조회
 - 예약조회완료 이벤트를 수신한 후, 콘서트 서비스에서 콘서트 정보를 조회합니다.
 - 콘서트 정보 조회에 성공하면 콘서트조회완료 이벤트를 발행하여 다음 단계로 진행합니다.
 - 조회 실패 시 예약취소 보상 트랜잭션을 실행하여 이전 단계의 예약을 취소합니다.
```text
콘서트정보조회 TX {
    콘서트정보조회()
    이벤트.콘서트조회완료발행() // 콘서트 정보 조회 성공 시
    // 콘서트 정보 조회 실패 시 보상 트랜잭션
    이벤트.예약취소발행() // 이전 예약 단계 취소
}  
```
#### 6.3. 예약 확정
- 예약조회완료 이벤트를 수신한 후, 콘서트 서비스에서 콘서트 정보를 조회합니다.
- 콘서트 정보 조회에 성공하면 콘서트조회완료 이벤트를 발행하여 다음 단계로 진행합니다.
- 조회 실패 시 예약취소 보상 트랜잭션을 실행하여 이전 단계의 예약을 취소합니다.
```text
콘서트정보조회 TX {
    콘서트정보조회()
    이벤트.콘서트조회완료발행() // 콘서트 정보 조회 성공 시
    // 콘서트 정보 조회 실패 시 보상 트랜잭션
    이벤트.예약취소발행() // 이전 예약 단계 취소
}  
```
#### 6.4. 결제 내역 생성
 - 예약확정완료 이벤트를 수신한 후, 결제 서비스에서 결제 내역을 생성합니다. 
 - 결제 내역 생성에 성공하면 결제생성완료 이벤트를 발행하여 다음 단계로 진행합니다. 
 - 결제 내역 생성 실패 시 예약취소 보상 트랜잭션을 실행하고, 포인트복구 보상 트랜잭션을 실행하여 포인트를 복구합니다.
```text
결제내역생성 TX {
    결제내역생성()
    이벤트.결제생성완료발행() // 결제 내역 생성 성공 시
    // 결제 내역 생성 실패 시 보상 트랜잭션
    이벤트.예약취소발행() // 이전 예약 단계 취소
    이벤트.포인트복구발행() // 포인트 복구
}
```

#### 6.5. 유저 포인트 차감
 - 결제생성완료 이벤트를 수신한 후, 포인트 서비스에서 사용자 포인트를 차감합니다. 
 - 포인트 차감에 성공하면 포인트차감완료 이벤트를 발행하여 다음 단계로 진행합니다. 
 - 포인트 차감 실패 시 결제취소 보상 트랜잭션을 실행하여 결제 내역을 롤백합니다.
```text
유저포인트차감 TX {
    유저포인트차감()
    이벤트.포인트차감완료발행() // 포인트 차감 성공 시
    // 포인트 차감 실패 시 보상 트랜잭션
    이벤트.결제취소발행() // 결제 내역 롤백
} 
```

#### 6.6. 유저 포인트 차감
 - 포인트차감완료 이벤트를 수신한 후, 토큰 서비스에서 토큰을 삭제합니다.
 - 토큰 삭제가 완료되면 토큰삭제완료 이벤트를 발행하여 SAGA 트랜잭션을 종료합니다. 
 - 토큰 삭제 실패 시 포인트복구 보상 트랜잭션을 실행하여 포인트를 복구하고, 예약취소 보상 트랜잭션을 실행하여 예약을 취소합니다.
```text
토큰삭제 TX {
    토큰삭제()
    이벤트.토큰삭제완료발행() // 토큰 삭제 성공 시
    // 토큰 삭제 실패 시 보상 트랜잭션
    이벤트.포인트복구발행() // 포인트 복구
    이벤트.예약취소발행() // 예약 취소
}
```

### 전체 결제 이벤트처리 요약
1. 예약내역조회 → 예약조회완료 이벤트 발행 
2. 콘서트정보조회 → 콘서트조회완료 이벤트 발행
3. 예약확정 → 예약확정완료 이벤트 발행
4. 결제내역생성 → 결제생성완료 이벤트 발행
5. 유저포인트차감 → 포인트차감완료 이벤트 발행
6. 토큰삭제 → 토큰삭제완료 이벤트 발행 (SAGA 종료)

7. 
